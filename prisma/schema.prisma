// Prisma Schema for Supabase PostgreSQL
// Supports both Development and Production environments

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  renter
  owner
  moderator
  admin
}

enum VerificationStatus {
  not_verified
  pending
  verified
  rejected
}

enum ItemStatus {
  draft
  pending
  approved
  rejected
}

enum Category {
  electronics
  clothes
  stream
  tools
  sports
  other
}

enum BookingStatus {
  pending_approval
  pending_payment
  paid
  active
  completed
  cancelled
}

enum RentalType {
  day
  month
}

enum ReviewType {
  renter_review
  owner_review
}

enum ApprovalMode {
  auto_approve
  manual
  rating_based
  verified_only
}

// ==================== MODELS ====================

model User {
  id                  String             @id @default(uuid())
  name                String
  email               String?            @unique
  phone               String             @unique
  passwordHash        String?            @map("password_hash")
  role                UserRole           @default(renter)
  rating              Float              @default(5.0)
  isVerified          Boolean            @default(false) @map("is_verified")
  verificationStatus  VerificationStatus @default(not_verified) @map("verification_status")
  isBlocked           Boolean            @default(false) @map("is_blocked")
  blockReason         String?            @map("block_reason")
  blockedAt           DateTime?          @map("blocked_at")
  blockedBy           String?            @map("blocked_by")
  photo               String?

  // Document verification
  documentPath        String?            @map("document_path")
  documentType        String?            @map("document_type")
  encryptedDocument   String?            @map("encrypted_document")
  verificationSubmittedAt DateTime?      @map("verification_submitted_at")
  verifiedAt          DateTime?          @map("verified_at")
  verifiedBy          String?            @map("verified_by")
  rejectionReason     String?            @map("rejection_reason")

  // Trust metrics (cached, recalculated on events)
  trustScore          Float              @default(0) @map("trust_score")
  completedDeals      Int                @default(0) @map("completed_deals")
  cancelledDeals      Int                @default(0) @map("cancelled_deals")
  confirmationRate    Float              @default(0) @map("confirmation_rate")
  avgResponseMinutes  Float?             @map("avg_response_minutes")
  trustBadges         String[]           @default([]) @map("trust_badges")
  trustUpdatedAt      DateTime?          @map("trust_updated_at")

  // Approval settings (default for all items)
  defaultApprovalMode       ApprovalMode   @default(auto_approve) @map("default_approval_mode")
  defaultApprovalThreshold  Float          @default(4.0) @map("default_approval_threshold")

  // Notification settings
  notifyEmail         Boolean            @default(true) @map("notify_email")
  notifyVk            Boolean            @default(false) @map("notify_vk")
  notifyTelegram      Boolean            @default(false) @map("notify_telegram")
  notifyPush          Boolean            @default(false) @map("notify_push")
  pushBookings        Boolean            @default(true) @map("push_bookings")
  pushChat            Boolean            @default(true) @map("push_chat")
  pushModeration      Boolean            @default(true) @map("push_moderation")
  pushReviews         Boolean            @default(true) @map("push_reviews")
  pushReminders       Boolean            @default(true) @map("push_reminders")
  notifyBookingRequests Boolean          @default(true) @map("notify_booking_requests")
  vkId                String?            @map("vk_id")
  telegramChatId      String?            @map("telegram_chat_id")

  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")

  // Relations
  items               Item[]             @relation("OwnerItems")
  bookingsAsRenter    Booking[]          @relation("RenterBookings")
  reviews             Review[]
  reviewReplies       ReviewReply[]
  sentMessages        Message[]          @relation("SentMessages")
  favorites           Favorite[]
  pushSubscriptions   PushSubscription[]
  verificationHistory VerificationHistory[] @relation("VerificationUser")
  verificationActions VerificationHistory[] @relation("VerificationAdmin")

  @@map("users")
}

model Item {
  id              String      @id @default(uuid())
  ownerId         String      @map("owner_id")
  category        Category
  subcategory     String?
  title           String
  description     String
  pricePerDay     Float       @map("price_per_day")
  pricePerMonth   Float       @map("price_per_month")
  deposit         Float
  address         String
  latitude        Float?
  longitude       Float?
  photos          String[]    @default([])
  attributes      Json?       @default("{}")
  status          ItemStatus  @default(pending)
  rating          Float?

  // Approval settings (per-item override, null = use owner default)
  approvalMode      ApprovalMode?  @map("approval_mode")
  approvalThreshold Float?         @map("approval_threshold")

  // Moderation
  moderatedAt     DateTime?   @map("moderated_at")
  moderatedBy     String?     @map("moderated_by")
  rejectionReason String?     @map("rejection_reason")

  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  owner           User        @relation("OwnerItems", fields: [ownerId], references: [id], onDelete: Cascade)
  bookings        Booking[]
  reviews         Review[]
  favorites       Favorite[]

  @@index([ownerId])
  @@index([category])
  @@index([status])
  @@index([createdAt])
  @@index([latitude, longitude])
  @@map("items")
}

model Booking {
  id            String        @id @default(uuid())
  itemId        String        @map("item_id")
  renterId      String        @map("renter_id")
  startDate     DateTime      @map("start_date")
  endDate       DateTime      @map("end_date")
  rentalType    RentalType    @map("rental_type")
  rentalPrice   Float         @map("rental_price")
  deposit       Float
  commission    Float
  insurance     Float         @default(0)
  totalPrice    Float         @map("total_price")
  prepayment    Float
  isInsured     Boolean       @default(false) @map("is_insured")
  status        BookingStatus @default(pending_payment)
  depositStatus String?       @map("deposit_status")
  paymentId     String?       @map("payment_id")
  yookassaPaymentId String?   @map("yookassa_payment_id")

  // Handover confirmations (Model B: deposit & remainder exchanged in person)
  depositConfirmedByRenter  Boolean   @default(false) @map("deposit_confirmed_by_renter")
  depositConfirmedByOwner   Boolean   @default(false) @map("deposit_confirmed_by_owner")
  remainderConfirmedByRenter Boolean  @default(false) @map("remainder_confirmed_by_renter")
  remainderConfirmedByOwner  Boolean  @default(false) @map("remainder_confirmed_by_owner")

  // Checklist photos
  handoverPhotos     String[]  @default([]) @map("handover_photos")
  returnPhotos       String[]  @default([]) @map("return_photos")
  handoverConfirmedAt DateTime? @map("handover_confirmed_at")
  returnConfirmedAt   DateTime? @map("return_confirmed_at")

  // Approval
  approvalDeadline  DateTime?     @map("approval_deadline")
  rejectionReason   String?       @map("rejection_reason")
  approvedAt        DateTime?     @map("approved_at")
  rejectedAt        DateTime?     @map("rejected_at")

  paidAt        DateTime?     @map("paid_at")
  completedAt   DateTime?     @map("completed_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  item          Item          @relation(fields: [itemId], references: [id], onDelete: Cascade)
  renter        User          @relation("RenterBookings", fields: [renterId], references: [id], onDelete: Cascade)
  reviews       Review[]
  messages      Message[]

  @@index([itemId])
  @@index([renterId])
  @@index([status])
  @@index([startDate, endDate])
  @@map("bookings")
}

model Review {
  id          String     @id @default(uuid())
  bookingId   String     @map("booking_id")
  itemId      String     @map("item_id")
  userId      String     @map("user_id")
  rating      Int
  text        String
  photos      String[]   @default([])
  type        ReviewType @default(renter_review)
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  booking     Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  item        Item       @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  reply       ReviewReply?

  @@unique([bookingId, type])
  @@index([itemId])
  @@index([userId])
  @@map("reviews")
}

model ReviewReply {
  id        String   @id @default(uuid())
  reviewId  String   @unique @map("review_id")
  ownerId   String   @map("owner_id")
  text      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@map("review_replies")
}

model SmsCode {
  id        String   @id @default(uuid())
  phone     String   @unique
  code      String
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")

  @@map("sms_codes")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")

  @@index([email])
  @@index([token])
  @@map("password_reset_tokens")
}

model MessengerLinkCode {
  id        String    @id @default(uuid())
  code      String    @unique
  type      String    // "vk" | "telegram"
  userId    String?   @map("user_id")
  chatId    String    @map("chat_id")
  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")

  @@index([code])
  @@index([chatId, type])
  @@map("messenger_link_codes")
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  itemId    String   @map("item_id")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  item      Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([userId, itemId])
  @@index([userId])
  @@map("favorites")
}

model Message {
  id        String   @id @default(uuid())
  bookingId String   @map("booking_id")
  senderId  String   @map("sender_id")
  text      String
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  sender    User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([bookingId, createdAt])
  @@index([senderId])
  @@map("messages")
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
  @@map("push_subscriptions")
}

model VerificationHistory {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  editorId   String   @map("editor_id")
  action     String   // "approve" | "reject"
  reason     String?
  entityType String   @default("user") @map("entity_type") // "user" | "item"
  entityId   String?  @map("entity_id") // item ID when entityType = "item"
  entityName String?  @map("entity_name") // item title for display
  createdAt  DateTime @default(now()) @map("created_at")

  user       User     @relation("VerificationUser", fields: [userId], references: [id], onDelete: Cascade)
  editor     User     @relation("VerificationAdmin", fields: [editorId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("verification_history")
}

model NotificationLog {
  id          String   @id @default(uuid())
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id")
  eventType   String   @map("event_type")
  recipientId String   @map("recipient_id")
  sentAt      DateTime @default(now()) @map("sent_at")

  @@unique([entityType, entityId, eventType, recipientId])
  @@index([entityType, eventType])
  @@index([sentAt])
  @@map("notification_log")
}
